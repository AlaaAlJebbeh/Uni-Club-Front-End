<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Convert | Export html Table to CSV & EXCEL File</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../public/styles/statusManagerStyke.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="../public/styles/details.css" />
  </head>

  <body>
    <header>
      <div>
        <a href="#" class="logo"
          ><img src="logo.png" alt="Logo" class="logo-image"
        /></a>
      </div>
      <input type="checkbox" id="nav_check" hidden />
      <nav class="navbar">
        <ul>
          <li>
            <a href="" class="active">Home</a>
          </li>
          <li>
            <a href="">Clubs</a>
          </li>
        </ul>
      </nav>

      <div class="icons">
        <div class="icons">
          <i class="fas fa-search" id="search-btn"></i>
          <i class="fas fa-user" id="log-btn"></i>
        </div>

        <form action="" class="search-bar-container">
          <input type="search" id="search-bar" placeholder="search here..." />
          <label for="search-bar" class="fas fa-search"></label>
        </form>
      </div>

      <label for="nav_check" class="sideBar icons">
        <div></div>
        <div></div>
        <div></div>
      </label>
    </header>
    <!--Font Linking-->
    <script>
      let searchBtn = document.querySelector("#search-btn");
      let searchBar = document.querySelector(".search-bar-container");

      searchBtn.addEventListener("click", () => {
        searchBtn.classList.toggle("fa-times");
        searchBar.classList.toggle("active");
      });
    </script>

    <main class="table" id="customers_table">
      <section class="table__header">
        <h1>Content Management</h1>
        <div class="input-group">
          <input type="search" placeholder="Search Request..." />
          <img src="images/search.png" alt="" />
        </div>
      </section>

      <section class="table__body">
        <table>
          <thead>
            <tr>
              <th>Club Name <span class="icon-arrow">&UpArrow;</span></th>
              <th>Request Type <span class="icon-arrow">&UpArrow;</span></th>
              <th>Status <span class="icon-arrow">&UpArrow;</span></th>
              <th>Action</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <% let index; %> <% tempResult.forEach(function(item,index){ %> <%
            let items = []; %> <% items.push(item); %>
            <tr>
              <td>
                <h4 style="color: black"><%=clubNames[index]%></h4>
              </td>
              <td><h4 style="color: black"><%=item.requestType%></h4></td>
              <td>
                <p class="status pending">Pending</p>
              </td>
              <td>
                <button class="approve-button">Approve</button>
                <button class="reject-button">Reject</button>
              </td>
              <td>
                <button
                  class="details-button"
                  onclick="showDetails()"
                  data-club-id="<%= item.club_id %>"
                >
                  <img src="public/images/Details.png" alt="Button Image" />
                </button>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </section>

      <div id="popup" class="popup-card" style="display: none">
        <div class="wrapper">
          <div class="flip-card">
            <div class="front card">
              <table class="custom-table">
                <tr>
                  <td class="column1">
                    <% if (tempResult[index - 1] && tempResult[index -
                    1].requestType === 'newimg') { %>
                    <img
                      src="<%= tempResult[index - 1].newImage %>"
                      alt="Old Image"
                    />
                    <% } else { %>
                    <p id="beforetext"></p>
                    <% } %>
                  </td>
                  <td class="column2">
                    <p id="after"></p>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <button id="closeButton" onclick="closePopup()">Close</button>
      </div>

      <div id="reject" class="reject-card1">
        <input
          type="text"
          id="rejectionReason"
          placeholder="Enter rejection reason..."
        />
        <button id="sendButton">Send</button>
        <button id="closeButton2" onclick="closePopup2()">Close</button>
      </div>
      <script>
        function showDetails(index) {
          // Retrieve the club ID from the button's data attribute
          var clubId = document
            .querySelector(`.details-button[data-club-id="${index}"]`)
            .getAttribute("data-club-id");

          // Fetch the old picture URL from the club table using AJAX
          fetch(`/getOldPicture?clubId=${clubId}`)
            .then((response) => response.json())
            .then((data) => {
              // Display the old picture URL in the popup
              document.getElementById("beforetext").innerText = data.image;
            })
            .catch((error) => {
              console.error("Error:", error);
            });

          // Show the popup
          document.getElementById("popup").style.display = "block";
        }
      </script>

      <script>
        // Function to show the popup card
        function showPopup() {
          document.getElementById("popup").style.display = "block";
        }

        // Function to close the popup card
        function closePopup() {
          document.getElementById("popup").style.display = "none";
        }

        // Attach click event listener to the button
        var buttons = document.querySelectorAll(".details-button");
        buttons.forEach(function (button) {
          button.addEventListener("click", function (e) {
            showPopup();
            // Display the concatenated keys
          });
        });

        console.log(beforeText);
      </script>

      <!-- Script for the Send button and cancel button in the reject request pop
      up-->
      <script>
        function showPopup2() {
          var popup = document.getElementById("reject");
          popup.style.display = "block";
        }

        function closePopup2() {
          var popup = document.getElementById("reject");
          popup.style.display = "none";
        }

        
        var sendButton = document.getElementById("sendButton");
        sendButton.addEventListener("click", function () {
            var rejectionReason = document.getElementById("rejectionReason").value;
            console.log("rejection Reason:", rejectionReason);
        
            // Send the rejection reason to the server
            fetch('/comparing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: rejectionReason })
            })
            .then(response => {
                if (response.ok) {
                    console.log("Rejection reason sent successfully");
                } else {
                    console.error("Failed to send rejection reason",response.status);
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        });
      // Get all elements with the class "reject-button"
      var rejectButtons = document.querySelectorAll(".reject-button");

      // Add event listener to each "Reject" button
      rejectButtons.forEach(function (button) {
          button.addEventListener("click", showPopup2);
      });

      // Check if rejectionReason is not empty
          if (rejectionReason.trim() !== '') {
            // If rejectionReason is not empty, insert it into the database
            const sql = 'INSERT INTO history_event (comment) VALUES (?)';
            connection.query(sql, [rejectionReason], (err, result) => {
                if (err) {
                    console.error('Error inserting rejection reason:', err);
                } else {
                    console.log('Rejection reason inserted successfully');
                    closePopup2();
                }
            });
          } else {
            console.error('Rejection reason is empty');
          }


        showPopup2();
      </script>
    </main>
    <footer>
      <div class="footerContainer">
        <div class="socialIcons">
          <a href=""><i class="fa-brands fa-facebook"></i></a>
          <a href=""><i class="fa-brands fa-instagram"></i></a>
          <a href=""><i class="fa-brands fa-twitter"></i></a>
          <a href=""><i class="fa-brands fa-linkedin"></i></a>
          <a href=""><i class="fa-brands fa-youtube"></i></a>
        </div>
        <div class="footerNav">
          <ul>
            <li><a href="">Home</a></li>
            <li><a href="">Uskudar University</a></li>
            <li><a href="">About SKS</a></li>
            <li><a href="">@sks.uskudar.edu.tr</a></li>
          </ul>
        </div>
      </div>
      <div class="footerBottom">
        <p>Copyright &copy;2024</p>
      </div>
    </footer>
    <script src="../public/scripts/StatusManagerScript.js"></script>
  </body>
</html>
